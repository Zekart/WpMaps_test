<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:piw="http://xmlns.jcp.org/jsf/composite/ezcomp"
      xmlns:addDialog="http://xmlns.jcp.org/jsf/composite/ezcomp"
      xmlns:tm="http://xmlns.jcp.org/jsf/composite/ezcomp"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    <h:head>
        <meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/> 
        
        <link rel="shortcut icon" type="image/png" href="#{request.contextPath}/resources/images/favicon.ico" />
        <title>WP Maps</title>
        <h:outputStylesheet library="css" name="pf_template.css" />
       <h:outputStylesheet library="css" name="simple_add_panell.css" /> 
        
        <script src = "http://maps.google.com/maps/api/js?key=AIzaSyDzwk44zfDh3JQSN1ooK-SIXzvODeFo_dc"
                type = "text/javascript" />
                
        <style>
            table {
                font-family: "Times New Roman", Times, serif;
                border-collapse: collapse;
                width: 100%;
                
            }

            td, th {
                border: 1px solid #dddddd;
                text-align: left;
                padding: 8px;
                color: green;
            }
            .ui-datalist .ui-widget-content
            {
                border-style: none !important
            } 
            
            
        </style>
    </h:head>
    <h:body>
        <h:form id="form" prependId="false" enctype="multipart/form-data" >
        
        <p:growl id="messages" sticky="true" />
        <p:gmap id ="gmap" center="#{gMapsController.centerGeoMap}" zoom="#{gMapsController.zoomMap}" type="terrain" model="#{gMapsController.model}"                 
                style="width: 100vw;height: 100vh;" onPointClick="handlePointClick(event);" widgetVar="map" fitBounds="false">
            
            <p:ajax event="overlaySelect" listener="#{gMapsController.onMarkerSelect}" />    
            <p:ajax event="geocode" listener="#{gMapsController.onGeocode}" update="@this" />           
            <p:ajax event="stateChange" listener="#{gMapsController.onStateChange}"  />

            <p:gmapInfoWindow id="infoWindow"   maxWidth="300">
                                    <h:panelGrid  columns="2" style="font: 8pt sans-serif; " styleClass="withOutBorder">
                        <p:row>
                            <h:outputLabel value="Тип: " />
                        </p:row>
                        <p:row>
                            <h:outputLabel  value="#{gMapsController.selected_point.decriminatorValue}" />
                        </p:row>
                        <p:row>
                            <h:outputLabel  value="Владелец:" />
                        </p:row>
                        <p:row>                            
                            <p:outputLabel value="#{gMapsController.selected_point.owner}"  />    
                        </p:row>                        
                        <p:row>
                            <h:outputLabel  value="Адрес:" />
                        </p:row>
                        <p:row>                            
                            <p:outputLabel value="#{gMapsController.selected_point.address}"  />    
                        </p:row>                        
                        <p:row>
                            <h:outputLabel  value="Муфта:" />                            
                        </p:row>     
                        <p:row>
                        <h:dataTable value="#{gMapsController.selected_point.clutch}" var="points">
                            <h:column>
                                <h:commandLink id="false"  onclick="showCabel()" >
                                    <h:outputText value="#{points.id}"/>                                        
                                </h:commandLink>
                            </h:column>
                        </h:dataTable>
                        </p:row>                        
                                
                    </h:panelGrid>                                                                                        


                <p:menuButton value="Действия" styleClass="selectFeatures">
                    <p:menuitem value="Удалить" actionListener="#{gMapsController.deleteMarker()}" update="gmap"/>
                    <p:menuitem value="Информ." action="#{gMapsController.setFlagToTrue()}" onclick="PF('dial').show()" update="toUpdate" />
                    <p:menuitem value="Соединить" action="#{gMapsController.connectPillar}"  />
                    <p:menuitem value="Изменить"  actionListener="#{gMapsController.viewCarsCustomized()}" />
                </p:menuButton>
            </p:gmapInfoWindow>              
        </p:gmap>

        <tm:topMenu/>

        <p:dialog widgetVar="dial">
            <p:outputPanel id="toUpdate" style="width: 20vw;">
                <p:panel id="myPanel" rendered="#{gMapsController.flag}" styleClass="withOutBorder" widgetVar="ww" toggleable="true" closable="true" toggleSpeed="500" closeSpeed="500">
                    <p:dataList value="#{gMapsController.selected_point.clutch}" var="cl" type="definition" >
                        <table style=" font: 10pt sans-serif;">
                            <tr>
                                <th>Муфта: #{cl.id}</th>                            
                            </tr>
                            <tr>
                                <td>Инфо:</td>
                                <td>#{cl.info}</td>
                            </tr>
                            <tr>
                                <td>Кол. кассет:</td>
                                <td>#{cl.cassetsCount}</td>
                            </tr>
                            <tr>
                                <td>Кабель:</td>
                                <td>in progress</td>
                            </tr>                    
                        </table>
                    </p:dataList>
                </p:panel>
            </p:outputPanel>             
        </p:dialog>       

        <p:dialog class="simple_add" showHeader="false" id="panelAdd" widgetVar="dlg" showEffect="fade" resizable="false" closable="false" width="1020" height="560" modal="true">           
            <addDialog:panelAddDialog/> 
            <h:inputHidden id="lat" value="#{mapObjController.lat}" />
            <h:inputHidden id="lng" value="#{mapObjController.lng}" /> 
        </p:dialog>

        <tm:user_info/>
        
    
        <p:dialog class="simple_add" showHeader="false" resizable="false" width="1020" modal="true" height="520" closable="false" widgetVar="drawChange" >
            <p:wizard id="wi"  widgetVar="wi" flowListener="#{pointWizard.onFlowProcess}" >
            <p:tab id="point" title="Точка" >
                <div class="parent">
                    <div class="div1">
                        <p:panel id="changePoint" style="background: transparent; border: none; " >

                            <h:panelGrid style="background: transparent; border: none; " rendered="#{gMapsController.decriminatorValue == 'Столб'}" columns="2"  >
                                <p:row>
                                    <p:column>Транспортная подстанция </p:column>
                                </p:row>
                                <p:row>
                                    <p:inputText  id="pil_name" class="add_inputfield" required="true" value="#{pillarController.p.transportStation}" requiredMessage="Пустые поля" >
                                    </p:inputText>                                           
                                </p:row>
                                <p:row>
                                    <p:column>Номер подстанции </p:column>
                                </p:row>
                                <p:row>
                                    <p:inputText required="true" class="add_inputfield" requiredMessage="Пустые поля" value="#{pillarController.p.numberStation}" >
                                    </p:inputText>
                                </p:row>  
                                <p:row>
                                    <p:column>Адрес: </p:column>
                                </p:row>
                                <p:row>
                                    <p:inputText required="true" class="add_inputfield" requiredMessage="Пустые поля" value="#{pillarController.p.address}">
                                    </p:inputText>
                                </p:row>                     
                                <p:row>
                                    <p:column>Балансодержатель опоры </p:column>
                                </p:row>
                                <p:row>
                                    <p:selectOneMenu id="p_owner" class="add_select" value="#{pillarController.p.owner}" >
                                        <f:selectItems var="st" value="#{pillarController.pillarOwner}" itemValue="#{st.ownerType}" itemLabel="#{st.ownerType}"/>
                                    </p:selectOneMenu>        
                                </p:row>
                                <p:row>
                                    <p:column>Материал столба </p:column>
                                </p:row>
                                <p:row>
                                    <p:selectOneMenu id="matheriall" class="add_select" value="#{pillarController.p.material}">
                                        <f:selectItems var="mat"  value="#{pillarController.pillarMaterial}" itemValue="#{mat}" itemLabel="#{mat.pillarMaterial}" />
                                    </p:selectOneMenu>                     
                                </p:row>   
                                <p:row>
                                    <p:column>Тип столба</p:column>
                                </p:row> 
                                <p:row>
                                    <p:selectOneMenu id="pillar_type" class="add_select" value="#{pillarController.p.type}" >
                                        <f:selectItems var="pl" value="#{pillarController.pillarType}" itemValue="#{pl}" itemLabel="#{pl.pilarType}"  />
                                    </p:selectOneMenu>     
                                </p:row>
                                <p:row>
                                    <p:column>Изображение</p:column>
                                </p:row>
                                <p:row>
                                    <p:fileUpload value="#{fileUploadView.image}" mode="simple" skinSimple="true" allowTypes="/(\.|\/)(gif|jpe?g|png)$/"/>
                                </p:row>                  
                            </h:panelGrid>    

                            <h:panelGrid style="background: transparent; border: none; " rendered="#{gMapsController.decriminatorValue == 'Дом'}" columns="2" >
                                <p:row>
                                    <p:column>Транспортная подстанция </p:column>
                                </p:row>
                                <p:row>
                                    <p:inputText value="{gMapsController.transportStation}" class="add_inputfield" >
                                        <f:validateLength minimum="1" />
                                    </p:inputText>                                           
                                </p:row>
                                <p:row>
                                    <p:column>Номер подстанции </p:column>
                                </p:row>
                                <p:row>
                                    <p:inputText  value="{gMapsController.numberStation}" class="add_inputfield">
                                        <f:validateLength minimum="1" />
                                    </p:inputText>
                                </p:row> 
                                <p:row>
                                    <p:column>Адрес: </p:column>
                                </p:row>
                                <p:row>
                                    <p:inputText id="addressP" value="{gMapsController.selected_point.address}" class="add_inputfield">
                                        <f:validateLength minimum="1" />
                                    </p:inputText>
                                </p:row>                     
                                <p:row>
                                    <p:column><p:outputLabel for="house_type" value="Тип дома" /> </p:column>
                                </p:row>
                                <p:row>
                                    <p:selectOneMenu id="house_type" class="add_select" value="{gMapsController.typeOfHouse}" >
                                        <f:selectItems var="ht" value="{gMapsController.houseType}" itemValue="{ht}" itemLabel="{ht.houseType}"/>
                                    </p:selectOneMenu>        
                                </p:row>
                                <p:row>
                                    <p:column>Владелец</p:column>
                                </p:row>         
                                <p:row>
                                    <p:selectOneMenu id="house_owner" class="add_select" value="{gMapsController.house_owner}" >
                                        <f:selectItems var="ho" value="{gMapsController.houseOwner}" itemValue="{ho}" itemLabel="{ho.houseOwner}"/>
                                    </p:selectOneMenu>        
                                </p:row>
                                <p:row>
                                    <p:column>Изображение</p:column>
                                </p:row>
                                <p:row>
                                    <p:fileUpload value="#{fileUploadView.image}" mode="simple" skinSimple="true" allowTypes="/(\.|\/)(gif|jpe?g|png)$/"/>
                                </p:row>                     
                            </h:panelGrid>

                            <h:panelGrid style="background: transparent; border: none; " rendered="{gMapsController.decriminatorValue == 'Колодец'}" columns="2" >                          
                                <p:row>
                                    <p:column>Транспортная подстанция </p:column>
                                </p:row>
                                <p:row>
                                    <p:inputText  id="dr_name" class="add_inputfield" required="true" value="{gMapsController.transportStation}" requiredMessage="Пустые поля" >
                                    </p:inputText>                                           
                                </p:row>
                                <p:row>
                                    <p:column>Номер подстанции </p:column>
                                </p:row>
                                <p:row>
                                    <p:inputText required="true" class="add_inputfield" requiredMessage="Пустые поля" value="{gMapsController.numberStation}" >
                                    </p:inputText>
                                </p:row>                                
                                <p:row>
                                    <p:column>Тип</p:column>
                                </p:row> 
                                <p:row>                    
                                    <p:selectOneMenu id="d_type" class="add_select" value="{gMapsController.type_drawWell}" >
                                        <f:selectItems var="ht" value="{gMapsController.drawWellType}" itemValue="{ht}" itemLabel="{ht.drawWellType}"/>
                                    </p:selectOneMenu>        
                                </p:row>
                                <p:row>
                                    <p:column>Адрес: </p:column>
                                </p:row>
                                <p:row>
                                    <p:inputText  value="{gMapsController.address}" class="add_inputfield">
                                        <f:validateLength minimum="1" />
                                    </p:inputText>
                                </p:row>                     
                                <p:row>
                                    <p:column>Владелец</p:column>
                                </p:row>         
                                <p:row>
                                    <p:selectOneMenu id="dl_owner" class="add_select" value="{gMapsController.draw_owner}"  >
                                        <f:selectItems var="hos" value="{gMapsController.drawWellOwner}" itemValue="{hos}" itemLabel="{hos.drawWellOwner}"/>
                                    </p:selectOneMenu>        
                                </p:row>
                                <p:row>
                                    <p:column>Изображение</p:column>
                                </p:row>
                                <p:row>
                                    <p:fileUpload value="#{fileUploadView.image}" mode="simple"  allowTypes="/(\.|\/)(gif|jpe?g|png)$/"/>
                                </p:row>                         
                            </h:panelGrid>    
                        </p:panel>

                    </div >                                                       
                </div>        
            <p:commandButton value="Отмена" onclick="PF('drawChange').hide()" class="butCancel"></p:commandButton>
            <p:commandButton value="save" action="#{gMapsController.updateDraw}" onclick="PF('drawChange').hide()" class="butAdd"></p:commandButton>
            </p:tab>        
                           
            <p:tab id="clutch" title="Муфта">
                <p:dataTable style=" bottom: 0;" value="#{gMapsController.selected_point.clutch}" var="clutch" editable="true">

                    <p:column style=" bottom: 0;" headerText="ID">
                        <h:outputText value="#{clutch.id}" />
                    </p:column>                
                    <p:column style=" bottom: 0;" headerText="Адрес">
                        <p:cellEditor>
                            <f:facet name="output"><h:outputText value="#{clutch.address}" /></f:facet>
                            <f:facet name="input"><p:inputText id="adrc" value="#{clutch.address}" style="width:100%"/></f:facet>
                        </p:cellEditor>                    
                    </p:column>
                    <p:column style=" bottom: 0;" headerText="Кол. кассет">
                        <p:cellEditor>
                            <f:facet name="output"><h:outputText value="#{clutch.cassetsCount}" /></f:facet>
                            <f:facet name="input"><p:inputText id="cl" value="#{clutchs.cassetsCount}" style="width:100%"/></f:facet>
                        </p:cellEditor>                    
                    </p:column>

                    <p:column style=" bottom: 0;" headerText="Состояние">
                        <p:cellEditor>
                            <f:facet name="output"><h:outputText value="#{clutch.conditions}" /></f:facet>
                            <f:facet name="input"><p:inputText id="cl_con" value="#{clutch.conditions}" style="width:100%"/></f:facet>
                        </p:cellEditor>                    
                    </p:column>
                    <p:column style=" bottom: 0;" headerText="Инфо">
                        <p:cellEditor>
                            <f:facet name="output"><h:outputText value="#{clutch.info}" /></f:facet>
                            <f:facet name="input"><p:inputText  value="#{clutch.info}" style="width:100%"/></f:facet>
                        </p:cellEditor>                     
                    </p:column>

                    <p:column style=" bottom: 0;" headerText="Входы">
                        <p:cellEditor>
                            <f:facet name="output"><h:outputText value="#{clutch.inputs}" /></f:facet>
                            <f:facet name="input"><p:inputText  value="#{clutch.inputs}" style="width:100%"/></f:facet>
                        </p:cellEditor>                    
                    </p:column>
                    <p:column style=" bottom: 0;width:32px">
                        <p:rowEditor />
                    </p:column>                
                </p:dataTable> 
            </p:tab>
            <p:tab id="confirm" title="Добавление">
                <div class="parent">
                    <h:panelGrid class="butAdd"  rendered="#{gMapsController.decriminatorValue == 'Колодец'}"  >
                        <p:commandButton value="Подтвердить" style="margin-left: 86%;" actionListener="#{gMapsController.updateDraw()}"  validateClient="true" update="gmap">
                            <p:ajax oncomplete="PF('wizp').loadStep('obj',false);" resetValues="true"/>
                        </p:commandButton>
                    </h:panelGrid> 
                    <h:panelGrid class="butAdd"  rendered="#{gMapsController.decriminatorValue == 'Дом'}"  >
                        <p:commandButton value="Подтвердить" style="margin-left: 86%;" actionListener="#{gMapsController.updateHouse()}"  validateClient="true" update="gmap">
                            <p:ajax oncomplete="PF('wizp').loadStep('obj',false);" resetValues="true"/>
                        </p:commandButton>
                    </h:panelGrid>
                    <h:panelGrid class="butAdd"  rendered="#{gMapsController.decriminatorValue == 'Столб'}"  >
                        <p:commandButton value="Подтвердить" style="margin-left: 86%;" actionListener="#{gMapsController.updatePillar()}"  validateClient="true" update="gmap">
                            <p:ajax oncomplete="PF('wizp').loadStep('obj',false);" resetValues="true"/>
                        </p:commandButton>
                    </h:panelGrid> 
                            <!--
                            <p:commandButton value="Submit" actionListener="{gMapsController.addMarkerP()}" validateClient="true" update="@all">
                                <f:setPropertyActionListener target="{pointWizard.data}" value="{gMapsController.obj_type}" />                                
                            </p:commandButton>
                            -->
                        <p:commandButton value="Отмена" onclick="return cancel()" class="butCancel">
                            <p:ajax oncomplete="PF('wizp').loadStep('obj',false);" resetValues="true"/>
                        </p:commandButton>
                </div>
            </p:tab>                

            </p:wizard>
        </p:dialog>
   
        <p:panel id="legend_panel" styleClass="legendPanel" visible="false" widgetVar="testPanel" closable="true" toggleable="true" >            
            <table style=" font: 8pt sans-serif; width: 17vw; " >
                <tr class="noBorder">                    
                    <td>Дом:</td>
                    <td><p:graphicImage height="27" width="27" value="../resources/marker/Дом_marker.png"  title="Дом/House"/></td>
                    <td>Колодец:</td>
                    <td><p:graphicImage height="27" width="27" value="../resources/marker/Колодец_marker.png" /></td>
                    <td>Столб:</td>
                    <td><p:graphicImage height="27" width="27" value="../resources/marker/Столб_marker.png" /></td>
                </tr>                  
            </table>  
        </p:panel>
        <p:panel id="search_panel" widgetVar="search_pan"  visible="false" >
            <h:panelGrid styleClass="searchPanel" columns="3" style="margin-bottom:10px" cellpadding="5">
                <p:inputText id="address" />
                <p:commandButton  icon="ui-icon-search" onclick="geocode()" type="button" />
            </h:panelGrid>            
        </p:panel>
       
        
    </h:form>  
    <script type="text/javascript">
        var currentMarker = null;
        var map = new google.maps.Map(document.getElementById('gmap'));
        var wind = null;
        var geocoder;
 
        function handlePointClick(event) {
            if(currentMarker === null) {
                document.getElementById('lat').value = event.latLng.lat();
                document.getElementById('lng').value = event.latLng.lng();
                currentMarker = new google.maps.Marker({
                    position:new google.maps.LatLng(event.latLng.lat(), event.latLng.lng())
                });

                PF('map').addOverlay(currentMarker);
                //if(confirm('Расширеный режим добавления?')){
                    var latN = event.latLng.lat();
                    var LngN = event.latLng.lng();
                    localStorage.setItem("lat",latN);
                    localStorage.setItem("lng",LngN);
                   // window.location.href = 'pointAddPage.xhtml';
                //} else {
                    PF('dlg').show();
                    //PF('dlg').show();
                    //currentMarker.setMap(null);
                    //currentMarker = null;
                //}
            }   
        }

        function cancel() {
            //PF('wizp').loadStep('obj', false);
            PF('dlg').hide();
            currentMarker.setMap(null);
            currentMarker = null;
            return false;
        }  
        
        function geocode() {
            PF('map').geocode(document.getElementById('address').value);
        }
        
        function openHistory(){
            var query = $('#legend_panel');
            var isVisible = query.is(':visible');
            if(isVisible === true){
              PF('testPanel').close();
            }else{
              PF('testPanel').show(); 
            }
            
        }
        function openSearch(){
            var query = $('#search_panel');
            var isVisible = query.is(':visible');
            if(isVisible === true){
              PF('search_pan').close();
            }else{
              PF('search_pan').show(); 
            }
            
        }        
        function closeWizard(){
            PF('dlg').hide();
            return false;
        }        
        function showCabel(){
            PF('cab_pan').show();
        }
               
    </script> 

    </h:body>
</html>

